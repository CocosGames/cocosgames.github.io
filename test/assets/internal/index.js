System.register("chunks:///_virtual/builtin-pipeline-settings.ts",["./rollupPluginModLoBabelHelpers.js","cc","./builtin-pipeline-types.ts"],(function(t){var e,i,n,o,r,a,s,p,l,g,c,u,d,y,h,b,m;return{setters:[function(t){e=t.applyDecoratedDescriptor,i=t.inheritsLoose,n=t.createClass,o=t.initializerDefineProperty,r=t.assertThisInitialized},function(t){a=t.cclegacy,s=t._decorator,p=t.Camera,l=t.CCBoolean,g=t.CCInteger,c=t.CCFloat,u=t.Material,d=t.Texture2D,y=t.rendering,h=t.Component},function(t){b=t.fillRequiredPipelineSettings,m=t.makePipelineSettings}],execute:function(){var P,_,f,S,M,G,C,w,v,E,O,D,k,j,A,R,L,x;a._RF.push({},"de1c2EHcMhAIYRZY5nyTQHG","builtin-pipeline-settings",void 0);var B=s.ccclass,T=s.disallowMultiple,z=s.executeInEditMode,I=s.menu,F=s.property,H=s.requireComponent;t("BuiltinPipelineSettings",(P=B("BuiltinPipelineSettings"),_=I("Rendering/BuiltinPipelineSettings"),f=H(p),S=F(l),M=F({displayName:"Editor Preview (Experimental)",type:l}),G=F({group:{id:"MSAA",name:"Multisample Anti-Aliasing"},type:l}),C=F({group:{id:"MSAA",name:"Multisample Anti-Aliasing",style:"section"},type:g,range:[2,4,2]}),w=F({group:{id:"ShadingScale",name:"ShadingScale",style:"section"},type:l}),v=F({tooltip:"i18n:postprocess.shadingScale",group:{id:"ShadingScale",name:"ShadingScale"},type:c,range:[.01,4,.01],slide:!0}),E=F({group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:l}),O=F({group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:u}),D=F({tooltip:"i18n:color_grading.contribute",group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:c,range:[0,1,.01],slide:!0}),k=F({tooltip:"i18n:color_grading.originalMap",group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:d}),j=F({group:{id:"ToneMapping",name:"ToneMapping",style:"section"},type:u}),P(A=_(A=f(A=T(A=z((L=e((R=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),a=0;a<i;a++)n[a]=arguments[a];return e=t.call.apply(t,[this].concat(n))||this,o(e,"_settings",L,r(e)),o(e,"_editorPreview",x,r(e)),e}i(e,t);var a=e.prototype;return a.getPipelineSettings=function(){return this._settings},a.onEnable=function(){b(this._settings),this.getComponent(p).camera.pipelineSettings=this._settings},a.onDisable=function(){this.getComponent(p).camera.pipelineSettings=null},a._tryEnableEditorPreview=function(){void 0!==y&&(this._editorPreview?y.setEditorPipelineSettings(this._settings):this._disableEditorPreview())},a._disableEditorPreview=function(){void 0!==y&&(y.getEditorPipelineSettings()===this._settings&&y.setEditorPipelineSettings(null))},n(e,[{key:"editorPreview",get:function(){return this._editorPreview},set:function(t){this._editorPreview=t}},{key:"MsaaEnable",get:function(){return this._settings.msaa.enabled},set:function(t){this._settings.msaa.enabled=t}},{key:"msaaSampleCount",get:function(){return this._settings.msaa.sampleCount},set:function(t){t=Math.pow(2,Math.ceil(Math.log2(Math.max(t,2)))),t=Math.min(t,4),this._settings.msaa.sampleCount=t}},{key:"shadingScaleEnable",get:function(){return this._settings.enableShadingScale},set:function(t){this._settings.enableShadingScale=t}},{key:"shadingScale",get:function(){return this._settings.shadingScale},set:function(t){this._settings.shadingScale=t}},{key:"colorGradingEnable",get:function(){return this._settings.colorGrading.enabled},set:function(t){this._settings.colorGrading.enabled=t}},{key:"colorGradingMaterial",get:function(){return this._settings.colorGrading.material},set:function(t){this._settings.colorGrading.material!==t&&(this._settings.colorGrading.material=t)}},{key:"colorGradingContribute",get:function(){return this._settings.colorGrading.contribute},set:function(t){this._settings.colorGrading.contribute=t}},{key:"colorGradingMap",get:function(){return this._settings.colorGrading.colorGradingMap},set:function(t){this._settings.colorGrading.colorGradingMap=t}},{key:"toneMappingMaterial",get:function(){return this._settings.toneMapping.material},set:function(t){this._settings.toneMapping.material!==t&&(this._settings.toneMapping.material=t)}}]),e}(h)).prototype,"_settings",[F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return m()}}),x=e(R.prototype,"_editorPreview",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),e(R.prototype,"editorPreview",[M],Object.getOwnPropertyDescriptor(R.prototype,"editorPreview"),R.prototype),e(R.prototype,"MsaaEnable",[G],Object.getOwnPropertyDescriptor(R.prototype,"MsaaEnable"),R.prototype),e(R.prototype,"msaaSampleCount",[C],Object.getOwnPropertyDescriptor(R.prototype,"msaaSampleCount"),R.prototype),e(R.prototype,"shadingScaleEnable",[w],Object.getOwnPropertyDescriptor(R.prototype,"shadingScaleEnable"),R.prototype),e(R.prototype,"shadingScale",[v],Object.getOwnPropertyDescriptor(R.prototype,"shadingScale"),R.prototype),e(R.prototype,"colorGradingEnable",[E],Object.getOwnPropertyDescriptor(R.prototype,"colorGradingEnable"),R.prototype),e(R.prototype,"colorGradingMaterial",[O],Object.getOwnPropertyDescriptor(R.prototype,"colorGradingMaterial"),R.prototype),e(R.prototype,"colorGradingContribute",[D],Object.getOwnPropertyDescriptor(R.prototype,"colorGradingContribute"),R.prototype),e(R.prototype,"colorGradingMap",[k],Object.getOwnPropertyDescriptor(R.prototype,"colorGradingMap"),R.prototype),e(R.prototype,"toneMappingMaterial",[j],Object.getOwnPropertyDescriptor(R.prototype,"toneMappingMaterial"),R.prototype),A=R))||A)||A)||A)||A)||A));a._RF.pop()}}}));

System.register("chunks:///_virtual/builtin-pipeline-types.ts",["cc"],(function(n){var e,a;return{setters:[function(n){e=n.cclegacy,a=n.gfx}],execute:function(){n({fillRequiredColorGrading:r,fillRequiredMSAA:o,fillRequiredPipelineSettings:function(n){n.msaa?o(n.msaa):n.msaa=l();void 0===n.enableShadingScale&&(n.enableShadingScale=!1);void 0===n.shadingScale&&(n.shadingScale=.5);n.toneMapping?c(n.toneMapping):n.toneMapping={material:null};n.colorGrading?r(n.colorGrading):n.colorGrading={enabled:!1,material:null,contribute:1,colorGradingMap:null}},fillRequiredToneMapping:c,makeColorGrading:t,makeMSAA:l,makePipelineSettings:function(){return{msaa:l(),enableShadingScale:!1,shadingScale:.5,toneMapping:{material:null},colorGrading:{enabled:!1,material:null,contribute:1,colorGradingMap:null}}},makeToneMapping:u}),e._RF.push({},"cbf30kCUX9A3K+QpVC6wnzx","builtin-pipeline-types",void 0);var i=a.SampleCount;function l(){return{enabled:!1,sampleCount:i.X4}}function o(n){void 0===n.enabled&&(n.enabled=!1),void 0===n.sampleCount&&(n.sampleCount=i.X4)}function t(){return{enabled:!1,material:null,contribute:1,colorGradingMap:null}}function r(n){void 0===n.enabled&&(n.enabled=!1),void 0===n.material&&(n.material=null),void 0===n.contribute&&(n.contribute=1),void 0===n.colorGradingMap&&(n.colorGradingMap=null)}function u(){return{material:null}}function c(n){void 0===n.material&&(n.material=null)}e._RF.pop()}}}));

System.register("chunks:///_virtual/builtin-pipeline.ts",["./rollupPluginModLoBabelHelpers.js","cc","./env","./builtin-pipeline-types.ts"],(function(e){var a,i,t,n,r,s,o,d,l,h,c,p,u,g,S,w,f;return{setters:[function(e){a=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy,t=e.geometry,n=e.gfx,r=e.renderer,s=e.Vec2,o=e.Vec4,d=e.assert,l=e.rendering,h=e.Vec3,c=e.Material,p=e.Layers,u=e.PipelineEventType,g=e.sys,S=e.pipeline},function(e){w=e.DEBUG},function(e){f=e.makePipelineSettings}],execute:function(){e({addCopyToScreenPass:I,getPingPongRenderTarget:z}),i._RF.push({},"ff9b0GZzgRM/obMbHGfCNbk","builtin-pipeline",void 0);var _=t.AABB,m=t.Sphere,M=t.intersect,R=n.ClearFlagBit,P=n.Color,E=n.Format,C=n.FormatFeatureBit,v=n.LoadOp,b=n.StoreOp,T=n.TextureType,L=n.Viewport,A=r.scene,D=A.CameraUsage,F=A.CSMLevel,N=A.LightType;function O(e){return!!(e.clearFlag&(R.COLOR|R.STENCIL<<1))}function x(e,a,i,t,n,r){e.shadowFixedArea||e.csmLevel===F.LEVEL_1?(n.left=0,n.top=0,n.width=Math.trunc(a),n.height=Math.trunc(i)):(n.left=Math.trunc(t%2*.5*a),n.top=r>0?Math.trunc(.5*(1-Math.floor(t/2))*i):Math.trunc(.5*Math.floor(t/2)*i),n.width=Math.trunc(.5*a),n.height=Math.trunc(.5*i)),n.left=Math.max(0,n.left),n.top=Math.max(0,n.top),n.width=Math.max(1,n.width),n.height=Math.max(1,n.height)}var y=e("PipelineConfigs",(function(){this.isWeb=!1,this.isWebGL1=!1,this.isWebGPU=!1,this.isMobile=!1,this.isHDR=!1,this.useFloatOutput=!1,this.toneMappingType=0,this.shadowEnabled=!1,this.shadowMapFormat=E.R32F,this.shadowMapSize=new s(1,1),this.usePlanarShadow=!1,this.screenSpaceSignY=1,this.supportDepthSample=!1,this.mobileMaxSpotLightShadowMaps=1,this.platform=new o(0,0,0,0)}));function B(e,a){var i=C.SAMPLED_TEXTURE|C.LINEAR_FILTER,t=e.device;a.isWeb=!g.isNative,a.isWebGL1=t.gfxAPI===n.API.WEBGL,a.isWebGPU=t.gfxAPI===n.API.WEBGPU,a.isMobile=g.isMobile,a.isHDR=e.pipelineSceneData.isHDR,a.useFloatOutput=e.getMacroBool("CC_USE_FLOAT_OUTPUT"),a.toneMappingType=e.pipelineSceneData.postSettings.toneMappingType;var s=e.pipelineSceneData.shadows;a.shadowEnabled=s.enabled,a.shadowMapFormat=S.supportsR32FloatTexture(e.device)?E.R32F:E.RGBA8,a.shadowMapSize.set(s.size),a.usePlanarShadow=s.enabled&&s.type===r.scene.ShadowType.Planar,a.screenSpaceSignY=e.device.capabilities.screenSpaceSignY,a.supportDepthSample=(e.device.getFormatFeatures(E.DEPTH_STENCIL)&i)===i;var o=t.capabilities.screenSpaceSignY;a.platform.x=a.isMobile?1:0,a.platform.w=.5*o+.5<<1|.5*t.capabilities.clipSpaceSignY+.5}var G=f(),H=e("CameraConfigs",(function(){this.settings=G,this.isMainGameWindow=!1,this.renderWindowId=0,this.colorName="",this.depthStencilName="",this.enableFullPipeline=!1,this.enableProfiler=!1,this.remainingPasses=0,this.enableShadingScale=!1,this.shadingScale=1,this.nativeWidth=1,this.nativeHeight=1,this.width=1,this.height=1,this.enableHDR=!1,this.radianceFormat=n.Format.RGBA8,this.copyAndTonemapMaterial=null,this.enableStoreSceneDepth=!1})),Q=new P(0,0,0,0);function I(e,a,i,t){d(!!i.copyAndTonemapMaterial);var n=e.addRenderPass(i.nativeWidth,i.nativeHeight,"cc-tone-mapping");return n.addRenderTarget(i.colorName,v.CLEAR,b.STORE,Q),n.addTexture(t,"inputTexture"),n.setVec4("g_platform",a.platform),n.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(i.copyAndTonemapMaterial,1),n}function z(e,a,i){return e.startsWith(a)?""+a+(1-Number(e.charAt(a.length)))+"_"+i:a+"0_"+i}var W=function(){function e(){this.lights=[],this.shadowEnabledSpotLights=[],this._sphere=m.create(0,0,0,1),this._boundingBox=new _,this._rangedDirLightBoundingBox=new _(0,0,0,.5,.5,.5)}var i=e.prototype;return i.cullLights=function(e,i,t){this.lights.length=0,this.shadowEnabledSpotLights.length=0;for(var n,r=a(e.spotLights);!(n=r()).done;){var s=n.value;s.baked||(m.set(this._sphere,s.position.x,s.position.y,s.position.z,s.range),M.sphereFrustum(this._sphere,i)&&(s.shadowEnabled?this.shadowEnabledSpotLights.push(s):this.lights.push(s)))}for(var o,d=a(e.sphereLights);!(o=d()).done;){var l=o.value;l.baked||(m.set(this._sphere,l.position.x,l.position.y,l.position.z,l.range),M.sphereFrustum(this._sphere,i)&&this.lights.push(l))}for(var c,p=a(e.pointLights);!(c=p()).done;){var u=c.value;u.baked||(m.set(this._sphere,u.position.x,u.position.y,u.position.z,u.range),M.sphereFrustum(this._sphere,i)&&this.lights.push(u))}for(var g,S=a(e.rangedDirLights);!(g=S()).done;){var w=g.value;_.transform(this._boundingBox,this._rangedDirLightBoundingBox,w.node.getWorldMatrix()),M.aabbFrustum(this._boundingBox,i)&&this.lights.push(w)}t&&this.shadowEnabledSpotLights.sort((function(e,a){return h.squaredDistance(t,e.position)-h.squaredDistance(t,a.position)}))},i._addLightQueues=function(e,i){for(var t,n=a(this.lights);!(t=n()).done;){var r=t.value,s=i.addQueue(l.QueueHint.BLEND,"forward-add");switch(r.type){case N.SPHERE:s.name="sphere-light";break;case N.SPOT:s.name="spot-light";break;case N.POINT:s.name="point-light";break;case N.RANGED_DIRECTIONAL:s.name="ranged-directional-light";break;default:s.name="unknown-light"}s.addScene(e,l.SceneFlags.BLEND,r)}},i.addSpotlightShadowPasses=function(e,i,t){for(var n,r=0,s=a(this.shadowEnabledSpotLights);!(n=s()).done;){var o=n.value,d=e.pipelineSceneData.shadows.size,h=e.addRenderPass(d.x,d.y,"default");if(h.name="SpotLightShadowPass"+r,h.addRenderTarget("SpotShadowMap"+r,v.CLEAR,b.STORE,new P(1,1,1,1)),h.addDepthStencil("SpotShadowDepth"+r,v.CLEAR,b.DISCARD),h.addQueue(l.QueueHint.NONE,"shadow-caster").addScene(i,l.SceneFlags.OPAQUE|l.SceneFlags.MASK|l.SceneFlags.SHADOW_CASTER).useLightFrustum(o),++r>=t)break}},i.addLightQueues=function(e,i,t){this._addLightQueues(i,e);for(var n,r=0,s=a(this.shadowEnabledSpotLights);!(n=s()).done;){var o=n.value;if(e.addTexture("SpotShadowMap"+r,"cc_spotShadowMap"),e.addQueue(l.QueueHint.BLEND,"forward-add").addScene(i,l.SceneFlags.BLEND,o),++r>=t)break}},i.addLightPasses=function(e,i,t,n,r,s,o,d,h,c){this._addLightQueues(o,c);for(var p,u=0,g=h.pipelineSceneData.shadows.size,S=a(this.shadowEnabledSpotLights);!(p=S()).done;){var w=p.value,f=h.addRenderPass(g.x,g.y,"default");f.name="SpotlightShadowPass",f.addRenderTarget("ShadowMap"+n,v.CLEAR,b.STORE,new P(1,1,1,1)),f.addDepthStencil("ShadowDepth"+n,v.CLEAR,b.DISCARD),f.addQueue(l.QueueHint.NONE,"shadow-caster").addScene(o,l.SceneFlags.OPAQUE|l.SceneFlags.MASK|l.SceneFlags.SHADOW_CASTER).useLightFrustum(w);var _=++u===this.shadowEnabledSpotLights.length?t:b.STORE;(c=h.addRenderPass(r,s,"default")).name="SpotlightWithShadowMap",c.setViewport(d),c.addRenderTarget(e,v.LOAD),c.addDepthStencil(i,v.LOAD,_),c.addTexture("ShadowMap"+n,"cc_spotShadowMap"),c.addQueue(l.QueueHint.BLEND,"forward-add").addScene(o,l.SceneFlags.BLEND,w)}return c},i.isMultipleLightPassesNeeded=function(){return this.shadowEnabledSpotLights.length>0},e}(),U=e("BuiltinForwardPassBuilder",function(){function e(){this.forwardLighting=new W,this._viewport=new L,this._clearColor=new P(0,0,0,1),this._reflectionProbeClearColor=new h(0,0,0)}var t=e.prototype;return t.getConfigOrder=function(){return e.ConfigOrder},t.getRenderOrder=function(){return e.RenderOrder},t.configCamera=function(e,a,i){i.enableMainLightShadowMap=a.shadowEnabled&&!a.usePlanarShadow&&!!e.scene&&!!e.scene.mainLight&&e.scene.mainLight.shadowEnabled,i.enableMainLightPlanarShadowMap=a.shadowEnabled&&a.usePlanarShadow&&!!e.scene&&!!e.scene.mainLight&&e.scene.mainLight.shadowEnabled,i.enablePlanarReflectionProbe=i.isMainGameWindow||e.cameraUsage===D.SCENE_VIEW||e.cameraUsage===D.GAME_VIEW,i.enableMSAA=i.settings.msaa.enabled&&!i.enableStoreSceneDepth&&!a.isWeb&&!a.isWebGL1,i.enableSingleForwardPass=a.isMobile||i.enableMSAA,++i.remainingPasses},t.windowResize=function(e,a,i,t,n,r,s){var o=l.ResourceFlags,d=l.ResourceResidency,h=t.renderWindowId,c=i.settings,p=i.enableShadingScale?Math.max(Math.floor(r*i.shadingScale),1):r,u=i.enableShadingScale?Math.max(Math.floor(s*i.shadingScale),1):s;if(i.enableMSAA&&(i.enableHDR?e.addTexture("MsaaRadiance"+h,T.TEX2D,i.radianceFormat,p,u,1,1,1,c.msaa.sampleCount,o.COLOR_ATTACHMENT,d.MEMORYLESS):e.addTexture("MsaaRadiance"+h,T.TEX2D,E.RGBA8,p,u,1,1,1,c.msaa.sampleCount,o.COLOR_ATTACHMENT,d.MEMORYLESS),e.addTexture("MsaaDepthStencil"+h,T.TEX2D,E.DEPTH_STENCIL,p,u,1,1,1,c.msaa.sampleCount,o.DEPTH_STENCIL_ATTACHMENT,d.MEMORYLESS)),e.addRenderTarget("ShadowMap"+h,a.shadowMapFormat,a.shadowMapSize.x,a.shadowMapSize.y),e.addDepthStencil("ShadowDepth"+h,E.DEPTH_STENCIL,a.shadowMapSize.x,a.shadowMapSize.y),i.enableSingleForwardPass)for(var g=a.mobileMaxSpotLightShadowMaps,S=0;S!==g;++S)e.addRenderTarget("SpotShadowMap"+S,a.shadowMapFormat,a.shadowMapSize.x,a.shadowMapSize.y),e.addDepthStencil("SpotShadowDepth"+S,E.DEPTH_STENCIL,a.shadowMapSize.x,a.shadowMapSize.y)},t.setup=function(e,a,i,t,n){var r=t.window.renderWindowId,s=t.scene,o=s.mainLight;--i.remainingPasses,d(i.remainingPasses>=0),this.forwardLighting.cullLights(s,t.frustum),i.enableMainLightShadowMap&&(d(!!o),this._addCascadedShadowMapPass(e,a,r,o,t)),i.enableSingleForwardPass&&this.forwardLighting.addSpotlightShadowPasses(e,t,a.mobileMaxSpotLightShadowMaps),this._tryAddReflectionProbePasses(e,i,r,o,t.scene),i.remainingPasses>0||i.enableShadingScale?(n.colorName=i.enableShadingScale?"ScaledRadiance0_"+r:"Radiance0_"+r,n.depthStencilName=i.enableShadingScale?"ScaledSceneDepth_"+r:"SceneDepth_"+r):(n.colorName=i.colorName,n.depthStencilName=i.depthStencilName);var l=this._addForwardRadiancePasses(e,a,i,r,t,i.width,i.height,o,n.colorName,n.depthStencilName,!i.enableMSAA,i.enableStoreSceneDepth?b.STORE:b.DISCARD);return i.enableStoreSceneDepth||(n.depthStencilName=""),0===i.remainingPasses&&i.enableShadingScale?I(e,a,i,n.colorName):l},t._addCascadedShadowMapPass=function(e,a,i,t,n){var r=l.QueueHint,s=l.SceneFlags,o=e.pipelineSceneData.shadows.size,d=o.x,h=o.y,c=this._viewport;c.left=c.top=0,c.width=d,c.height=h;var p=e.addRenderPass(d,h,"default");p.name="CascadedShadowMap",p.addRenderTarget("ShadowMap"+i,v.CLEAR,b.STORE,new P(1,1,1,1)),p.addDepthStencil("ShadowDepth"+i,v.CLEAR,b.DISCARD);for(var u=e.pipelineSceneData.csmSupported?t.csmLevel:1,g=0;g!==u;++g){x(t,d,h,g,this._viewport,a.screenSpaceSignY);var S=p.addQueue(r.NONE,"shadow-caster");a.isWebGPU||S.setViewport(this._viewport),S.addScene(n,s.OPAQUE|s.MASK|s.SHADOW_CASTER).useLightFrustum(t,g)}},t._tryAddReflectionProbePasses=function(e,t,s,o,d){var h=i.internal.reflectionProbeManager;if(h)for(var c,p=l.ResourceResidency,u=h.getProbes(),g=0,S=a(u);!(c=S()).done;){var w=c.value;if(w.needRender){var f=w.renderArea(),_=Math.max(Math.floor(f.x),1),m=Math.max(Math.floor(f.y),1);if(w.probeType===r.scene.ProbeType.PLANAR){if(!t.enablePlanarReflectionProbe)continue;var M=w.realtimePlanarTexture.window,R="PlanarProbeRT"+g,P="PlanarProbeDS"+g;e.addRenderWindow(R,t.radianceFormat,_,m,M),e.addDepthStencil(P,n.Format.DEPTH_STENCIL,_,m,p.MEMORYLESS);var E=e.addRenderPass(_,m,"default");E.name="PlanarReflectionProbe"+g,this._buildReflectionProbePass(E,t,s,w.camera,R,P,o,d)}if(4===++g)break}}},t._buildReflectionProbePass=function(e,a,i,t,n,r,s,o){void 0===o&&(o=null);var d=l.QueueHint,h=l.SceneFlags,c=a.enableMSAA?b.DISCARD:b.STORE;if(O(t)){this._reflectionProbeClearColor.x=t.clearColor.x,this._reflectionProbeClearColor.y=t.clearColor.y,this._reflectionProbeClearColor.z=t.clearColor.z;var p=l.packRGBE(this._reflectionProbeClearColor);this._clearColor.x=p.x,this._clearColor.y=p.y,this._clearColor.z=p.z,this._clearColor.w=p.w,e.addRenderTarget(n,v.CLEAR,c,this._clearColor)}else e.addRenderTarget(n,v.LOAD,c);t.clearFlag&R.DEPTH_STENCIL?e.addDepthStencil(r,v.CLEAR,b.DISCARD,t.clearDepth,t.clearStencil,t.clearFlag&R.DEPTH_STENCIL):e.addDepthStencil(r,v.LOAD,b.DISCARD),a.enableMainLightShadowMap&&e.addTexture("ShadowMap"+i,"cc_shadowMap"),e.addQueue(d.NONE,"reflect-map").addScene(t,h.OPAQUE|h.MASK|h.REFLECTION_PROBE,s||void 0,o||void 0)},t._addForwardRadiancePasses=function(e,a,i,t,n,r,s,o,h,c,p,u){void 0===p&&(p=!1),void 0===u&&(u=b.DISCARD);var g=l.QueueHint,S=l.SceneFlags,w=n.clearColor;this._clearColor.x=w.x,this._clearColor.y=w.y,this._clearColor.z=w.z,this._clearColor.w=w.w;var f=n.viewport;this._viewport.left=Math.round(f.x*r),this._viewport.top=Math.round(f.y*s),this._viewport.width=Math.max(Math.round(f.width*r),1),this._viewport.height=Math.max(Math.round(f.height*s),1);var _=!p&&i.enableMSAA;d(!_||i.enableSingleForwardPass);var m=i.enableSingleForwardPass?this._addForwardSingleRadiancePass(e,a,i,t,n,_,r,s,o,h,c,u):this._addForwardMultipleRadiancePasses(e,i,t,n,r,s,o,h,c,u);i.enableMainLightPlanarShadowMap&&this._addPlanarShadowQueue(n,o,m);var M=S.BLEND|(n.geometryRenderer?S.GEOMETRY:S.NONE);return m.addQueue(g.BLEND).addScene(n,M,o||void 0),m},t._addForwardSingleRadiancePass=function(e,a,i,t,n,r,s,o,l,h,c,p){var u;if(d(i.enableSingleForwardPass),r){var g="MsaaRadiance"+t,S="MsaaDepthStencil"+t,w=i.settings.msaa.sampleCount,f=e.addMultisampleRenderPass(s,o,w,0,"default");f.name="MsaaForwardPass",this._buildForwardMainLightPass(f,i,t,n,g,S,b.DISCARD,l),f.resolveRenderTarget(g,h),u=f}else(u=e.addRenderPass(s,o,"default")).name="ForwardPass",this._buildForwardMainLightPass(u,i,t,n,h,c,p,l);return d(void 0!==u),this.forwardLighting.addLightQueues(u,n,a.mobileMaxSpotLightShadowMaps),u},t._addForwardMultipleRadiancePasses=function(e,a,i,t,n,r,s,o,l,h){d(!a.enableSingleForwardPass);var c=e.addRenderPass(n,r,"default");c.name="ForwardPass";var p=this.forwardLighting.isMultipleLightPassesNeeded()?b.STORE:h;return this._buildForwardMainLightPass(c,a,i,t,o,l,p,s),c=this.forwardLighting.addLightPasses(o,l,h,i,n,r,t,this._viewport,e,c)},t._buildForwardMainLightPass=function(e,a,i,t,n,r,s,o,d){void 0===d&&(d=null);var h=l.QueueHint,c=l.SceneFlags;e.setViewport(this._viewport);var p=a.enableMSAA?b.DISCARD:b.STORE;O(t)?e.addRenderTarget(n,v.CLEAR,p,this._clearColor):e.addRenderTarget(n,v.LOAD,p),t.clearFlag&R.DEPTH_STENCIL?e.addDepthStencil(r,v.CLEAR,s,t.clearDepth,t.clearStencil,t.clearFlag&R.DEPTH_STENCIL):e.addDepthStencil(r,v.LOAD,s),a.enableMainLightShadowMap&&e.addTexture("ShadowMap"+i,"cc_shadowMap"),e.addQueue(h.NONE).addScene(t,c.OPAQUE|c.MASK,o||void 0,d||void 0)},t._addPlanarShadowQueue=function(e,a,i){var t=l.QueueHint,n=l.SceneFlags;i.addQueue(t.BLEND,"planar-shadow").addScene(e,n.SHADOW_CASTER|n.PLANAR_SHADOW|n.BLEND,a||void 0)},e}());U.ConfigOrder=100,U.RenderOrder=100;var V=e("BuiltinToneMappingPassBuilder",function(){function e(){this._colorGradingTexSize=new s(0,0)}var a=e.prototype;return a.getConfigOrder=function(){return 0},a.getRenderOrder=function(){return 300},a.configCamera=function(e,a,i){var t=i.settings;i.enableColorGrading=t.colorGrading.enabled&&!!t.colorGrading.material&&!!t.colorGrading.colorGradingMap,i.enableToneMapping=i.enableHDR||i.enableColorGrading,i.enableToneMapping&&++i.remainingPasses},a.windowResize=function(e,a,i){i.enableColorGrading&&(d(!!i.settings.colorGrading.material),i.settings.colorGrading.material.setProperty("colorGradingMap",i.settings.colorGrading.colorGradingMap))},a.setup=function(e,a,i,t,n,r){if(!i.enableToneMapping)return r;if(--i.remainingPasses,d(i.remainingPasses>=0),0===i.remainingPasses)return this._addCopyAndTonemapPass(e,a,i,i.nativeWidth,i.nativeHeight,n.colorName,i.colorName);var s=i.renderWindowId,o=i.enableShadingScale?"ScaledLdrColor":"LdrColor",l=z(n.colorName,o,s),h=n.colorName;return n.colorName=l,this._addCopyAndTonemapPass(e,a,i,i.width,i.height,h,l)},a._addCopyAndTonemapPass=function(e,a,i,t,n,r,s){var o,h=i.settings;if(i.enableColorGrading){d(!!h.colorGrading.material),d(!!h.colorGrading.colorGradingMap);var c=h.colorGrading.colorGradingMap;this._colorGradingTexSize.x=c.width,this._colorGradingTexSize.y=c.height;var p=c.width===c.height;(o=p?e.addRenderPass(t,n,"cc-color-grading-8x8"):e.addRenderPass(t,n,"cc-color-grading-nx1")).addRenderTarget(s,v.CLEAR,b.STORE,Q),o.addTexture(r,"sceneColorMap"),o.setVec4("g_platform",a.platform),o.setVec2("lutTextureSize",this._colorGradingTexSize),o.setFloat("contribute",h.colorGrading.contribute),o.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(h.colorGrading.material,p?1:0)}else(o=e.addRenderPass(t,n,"cc-tone-mapping")).addRenderTarget(s,v.CLEAR,b.STORE,Q),o.addTexture(r,"inputTexture"),o.setVec4("g_platform",a.platform),h.toneMapping.material?o.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(h.toneMapping.material,0):(d(!!i.copyAndTonemapMaterial),o.addQueue(l.QueueHint.OPAQUE).addFullscreenQuad(i.copyAndTonemapMaterial,0));return o},e}()),k=e("BuiltinUiPassBuilder",function(){function e(){}var a=e.prototype;return a.getConfigOrder=function(){return 0},a.getRenderOrder=function(){return 1e3},a.setup=function(e,a,i,t,n,r){d(!!r);var s=l.SceneFlags.UI;return i.enableProfiler&&(s|=l.SceneFlags.PROFILER,r.showStatistics=!0),r.addQueue(l.QueueHint.BLEND,"default","default").addScene(t,s),r},e}());if(l){var Y=l.QueueHint,K=l.SceneFlags,X=function(){function e(){this._pipelineEvent=i.director.root.pipelineEvent,this._forwardPass=new U,this._toneMappingPass=new V,this._uiPass=new k,this._clearColor=new P(0,0,0,1),this._viewport=new L,this._configs=new y,this._cameraConfigs=new H,this._copyAndTonemapMaterial=new c,this._initialized=!1,this._passBuilders=[]}var t=e.prototype;return t._setupPipelinePreview=function(e,a){if(e.cameraUsage===D.SCENE_VIEW||e.cameraUsage===D.PREVIEW){var i=l.getEditorPipelineSettings();a.settings=i||G}else e.pipelineSettings?a.settings=e.pipelineSettings:a.settings=G},t._preparePipelinePasses=function(e){var i=this._passBuilders;i.length=0;var t=e.settings;if(t._passes){for(var n,r=a(t._passes);!(n=r()).done;){var s=n.value;i.push(s)}d(i.length===t._passes.length)}i.push(this._forwardPass),i.push(this._toneMappingPass),i.push(this._uiPass)},t._setupBuiltinCameraConfigs=function(e,a,i){var t=e.window,r=e.cameraUsage===D.GAME&&!!t.swapchain;i.isMainGameWindow=r,i.renderWindowId=t.renderWindowId,i.colorName=t.colorName,i.depthStencilName=t.depthStencilName,i.enableFullPipeline=0!=(e.visibility&p.Enum.DEFAULT),i.enableProfiler=w,i.remainingPasses=0,i.shadingScale=i.settings.shadingScale,i.enableShadingScale=i.settings.enableShadingScale&&1!==i.shadingScale,i.nativeWidth=Math.max(Math.floor(t.width),1),i.nativeHeight=Math.max(Math.floor(t.height),1),i.width=i.enableShadingScale?Math.max(Math.floor(i.nativeWidth*i.shadingScale),1):i.nativeWidth,i.height=i.enableShadingScale?Math.max(Math.floor(i.nativeHeight*i.shadingScale),1):i.nativeHeight,i.enableHDR=i.enableFullPipeline&&a.useFloatOutput,i.radianceFormat=i.enableHDR?n.Format.RGBA16F:n.Format.RGBA8,i.copyAndTonemapMaterial=this._copyAndTonemapMaterial,i.enableStoreSceneDepth=!1},t._setupCameraConfigs=function(e,i,t){this._setupPipelinePreview(e,t),this._preparePipelinePasses(t),this._passBuilders.sort((function(e,a){return e.getConfigOrder()-a.getConfigOrder()})),this._setupBuiltinCameraConfigs(e,i,t);for(var n,r=a(this._passBuilders);!(n=r()).done;){var s=n.value;s.configCamera&&s.configCamera(e,i,t)}},t.windowResize=function(e,i,t,n,r){B(e,this._configs),this._setupCameraConfigs(t,this._configs,this._cameraConfigs);var s=i.renderWindowId;e.addRenderWindow(this._cameraConfigs.colorName,E.RGBA8,n,r,i,this._cameraConfigs.depthStencilName);var o=this._cameraConfigs.width,d=this._cameraConfigs.height;this._cameraConfigs.enableShadingScale?(e.addDepthStencil("ScaledSceneDepth_"+s,E.DEPTH_STENCIL,o,d),e.addRenderTarget("ScaledRadiance0_"+s,this._cameraConfigs.radianceFormat,o,d),e.addRenderTarget("ScaledRadiance1_"+s,this._cameraConfigs.radianceFormat,o,d),e.addRenderTarget("ScaledLdrColor0_"+s,E.RGBA8,o,d),e.addRenderTarget("ScaledLdrColor1_"+s,E.RGBA8,o,d)):(e.addDepthStencil("SceneDepth_"+s,E.DEPTH_STENCIL,o,d),e.addRenderTarget("Radiance0_"+s,this._cameraConfigs.radianceFormat,o,d),e.addRenderTarget("Radiance1_"+s,this._cameraConfigs.radianceFormat,o,d),e.addRenderTarget("LdrColor0_"+s,E.RGBA8,o,d),e.addRenderTarget("LdrColor1_"+s,E.RGBA8,o,d)),e.addRenderTarget("UiColor0_"+s,E.RGBA8,n,r),e.addRenderTarget("UiColor1_"+s,E.RGBA8,n,r);for(var l,h=a(this._passBuilders);!(l=h()).done;){var c=l.value;c.windowResize&&c.windowResize(e,this._configs,this._cameraConfigs,i,t,n,r)}},t.setup=function(e,i){if(!this._initMaterials(i))for(var t,n=a(e);!(t=n()).done;){var r=t.value;r.scene&&r.window&&(this._setupCameraConfigs(r,this._configs,this._cameraConfigs),this._pipelineEvent.emit(u.RENDER_CAMERA_BEGIN,r),this._cameraConfigs.enableFullPipeline?this._buildForwardPipeline(i,r,r.scene,this._passBuilders):this._buildSimplePipeline(i,r),this._pipelineEvent.emit(u.RENDER_CAMERA_END,r))}},t._buildSimplePipeline=function(e,a){var i=Math.max(Math.floor(a.window.width),1),t=Math.max(Math.floor(a.window.height),1),n=this._cameraConfigs.colorName,r=this._cameraConfigs.depthStencilName,s=a.viewport;this._viewport.left=Math.round(s.x*i),this._viewport.top=Math.round(s.y*t),this._viewport.width=Math.max(Math.round(s.width*i),1),this._viewport.height=Math.max(Math.round(s.height*t),1);var o=a.clearColor;this._clearColor.x=o.x,this._clearColor.y=o.y,this._clearColor.z=o.z,this._clearColor.w=o.w;var d=e.addRenderPass(i,t,"default");O(a)?d.addRenderTarget(n,v.CLEAR,b.STORE,this._clearColor):d.addRenderTarget(n,v.LOAD,b.STORE),a.clearFlag&R.DEPTH_STENCIL?d.addDepthStencil(r,v.CLEAR,b.DISCARD,a.clearDepth,a.clearStencil,a.clearFlag&R.DEPTH_STENCIL):d.addDepthStencil(r,v.LOAD,b.DISCARD),d.setViewport(this._viewport),d.addQueue(Y.OPAQUE).addScene(a,K.OPAQUE);var l=K.BLEND|K.UI;this._cameraConfigs.enableProfiler&&(l|=K.PROFILER,d.showStatistics=!0),d.addQueue(Y.BLEND).addScene(a,l)},t._buildForwardPipeline=function(e,i,t,n){!function(e){e.sort((function(e,a){return e.getRenderOrder()-a.getRenderOrder()}))}(n);for(var r,s={colorName:"",depthStencilName:""},o=void 0,l=a(n);!(r=l()).done;){var h=r.value;h.setup&&(o=h.setup(e,this._configs,this._cameraConfigs,i,s,o))}d(0===this._cameraConfigs.remainingPasses)},t._initMaterials=function(e){return this._initialized?0:(B(e,this._configs),this._copyAndTonemapMaterial._uuid="builtin-pipeline-tone-mapping-material",this._copyAndTonemapMaterial.initialize({effectName:"pipeline/post-process/tone-mapping"}),this._copyAndTonemapMaterial.effectAsset&&(this._initialized=!0),this._initialized?0:1)},e}();l.setCustomPipeline("Builtin",new X)}i._RF.pop()}}}));

System.register("chunks:///_virtual/internal",["./builtin-pipeline-settings.ts","./builtin-pipeline-types.ts","./builtin-pipeline.ts"],(function(){return{setters:[null,null,null],execute:function(){}}}));

(function(r) {
  r('virtual:///prerequisite-imports/internal', 'chunks:///_virtual/internal'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});